/* Copyright ï¿½ 2014-2020 Moxie Software. All Rights Reserved. Concierge Version: v1.17.3 */
!function(s){"use strict";function r(e,s){m(e+s.stack?s.stack:s.message)}function o(e){return e.signature="moxie_concierge",e}var c="",a=null,l=null,u=null,g=["moxie_cc"],f={ls:[],ss:[]},d={ls:{},ss:{}},S=!1,m=function(e){void 0!==s.GoMoxie&&"undefined"!==s.GoMoxie.console?s.GoMoxie.console.log(e):void 0!==s.console&&s.console.log(e)};function v(s){if(null===s)return null;try{var e=s.charAt(0);return"{"===e||"["===e||'"'===e?JSON.parse(s):s}catch(e){return m("JSON: StorageBridge unable to parse: ",s),""}}function y(e,s){var t=e.indexOf(s);return 0<=t?e.splice(t,1):null}function p(){var e=JSON.stringify(Date.now());localStorage.setItem(c+"|update-time",e),S&&sessionStorage.setItem("ls-"+c+"|update-time",e)}function k(e){var s=e.indexOf("|");return 0<s&&(e=e.slice(s+1)),e}function N(e,s,t){var r=e.getItem(s);return r!==t&&e.setItem(s,t),r}function h(e,s){for(var t,r=s.length,n=[],i=0;i<r;i++)0===(t=s.key(i)).indexOf(e)&&n.push(t);return n}function n(){var e,s=localStorage.getItem(c+"|update-time"),t=sessionStorage.getItem("ls-"+c+"|update-time"),r=!!s,n={ssUpdateTime:t,updateTime:s,ssUpdateTimeNumber:Number(t),updateTimeNumber:Number(s),shouldCopy:t&&(!s||Number(t)>Number(s))};if(m("Check to copy: "+JSON.stringify(n)),t){if(!s||Number(t)>Number(s)){m("Copying shared keys from session_storage into local_storage");var i=function(e){for(var s=[],t=e.length,r=0;r<t;r++)s[r]=k(e[r]);return s}(h(c+"|",localStorage));y(i,"client-keys"),y(i,"update-time");var o=sessionStorage.getItem("ls-"+c+"|client-keys");if(o){var a=v(o);for(e=0;e<a.length;e++){var l=k(a[e]);y(i,l);var u=sessionStorage.getItem("ls-"+c+"|"+l);N(localStorage,c+"|"+l,u)}for(N(localStorage,c+"|client-keys",o),e=i.length;0<e;e--)localStorage.removeItem(i[e-1])}r=!1}s&&Number(t)===Number(s)&&(r=!1)}return r}function i(e,s){var t,r,n,i,o,a=e?localStorage:sessionStorage;if(t=a.getItem(c+"|client-keys"))for(f[s]=r=v(t),n=0;n<r.length;n++)o=k(r[n]),e&&0===o.indexOf("ls-")||!e&&"update-time"===o||(i=a.getItem(c+"|"+o),d[s][o]=v(i))}function I(e,s){return e=e||{},s.requesterId&&(e.requesterId=s.requesterId),s.requestId&&(e.requestId=s.requestId),e.bridgeName="storage_bridge",e}function e(e,s){if(c)m('StorageBridge: initClient has already been invoked for "'+c+'"" event: "'+e.client+'"');else{c=e.client,a=s.source,l=s.origin,u=e.requesterId;var t=!1;(S=e.shadowInSessionStorage||!1)&&(t=n()),i(!0,"ls"),i(!1,"ss"),t&&function(e){for(var s=0;s<e.length;s++){var t=k(e[s]),r=localStorage.getItem(c+"|"+t);N(sessionStorage,"ls-"+c+"|"+t,r)}N(sessionStorage,"ls-"+c+"|client-keys",JSON.stringify(e)),p()}(f.ls)}return I({request:"initResponse",lsValue:d.ls,ssValue:d.ss},e)}function O(e,s){for(var t=h(e,s),r=t.length,n=0;n<r;n++)s.removeItem(t[n])}function t(s){var t=s.data;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return void r("StorageBridge: handleRequest parsing error: ",e)}if(s.origin,function(e){return"moxie_concierge"===e.signature}(t))try{switch(t.request){case"init":s.source.postMessage(JSON.stringify(o(e(t,s))),s.origin);break;case"clear":s.source.postMessage(JSON.stringify(o(function(e){var s=c+"|";return O(s,sessionStorage),O(s,localStorage),S&&(O("ls-"+s,localStorage),O("ls-"+s,sessionStorage)),f.ls=[],f.ss=[],N(sessionStorage,c+"|client-keys","[]"),N(localStorage,c+"|client-keys","[]"),S&&N(sessionStorage,"ls-"+c+"|client-keys","[]"),p(),I({request:"ack"},e)}(t))),s.origin);break;case"store":s.source.postMessage(JSON.stringify(o(function(e){var s=c+"|"+e.key,t=e.persist?"ls":"ss",r=e.persist?localStorage:sessionStorage,n=JSON.stringify(e.value);if(N(r,s,n),f[t].indexOf(s)<0){f[t].push(s);var i=JSON.stringify(f[t]);N(r,c+"|client-keys",i),e.persist&&S&&N(sessionStorage,"ls-"+c+"|client-keys",i)}return e.persist&&(p(),S&&N(sessionStorage,"ls-"+e.client+"|"+e.key,n)),I({request:"ack"},e)}(t))),s.origin);break;case"remove":s.source.postMessage(JSON.stringify(o(function(e){var s=c+"|"+e.key,t=e.persist?"ls":"ss",r=e.persist?localStorage:sessionStorage;if(0<=f[t].indexOf(s)){f[t].splice(f[t].indexOf(s),1);var n=JSON.stringify(f[t]);N(r,c+"|client-keys",n),r.removeItem(s),e.persist&&(p(),S&&(N(sessionStorage,"ls-"+c+"|client-keys",n),sessionStorage.removeItem("ls-"+c+"|"+e.key)))}return I({request:"ack"},e)}(t))),s.origin)}}catch(e){r("StorageBridge.handleRequest: error: ",e),s.source.postMessage(JSON.stringify(o(I({error:{message:e.message,stack:e.stack}},t))),s.origin)}}function b(e){try{var s=e.key,t=s.indexOf("|");if(0<t){var r=s.slice(0,t),n=s.slice(t+1);if(r===c&&0<=g.indexOf(n)){if(null!==a){var i=o(I({request:"updated",key:n,oldValue:e.oldValue,newValue:e.newValue},{requesterId:u}));a.postMessage(JSON.stringify(i),l)}return}}}catch(e){}}s.addEventListener?(s.addEventListener("message",t),s.addEventListener("storage",b)):s.attachEvent&&(s.attachEvent("onmessage",t),s.attachEvent("onstorage",b))}(window);